@page "/"
@using Microsoft.EntityFrameworkCore
@using Models;
@using Microsoft.AspNetCore.Authorization;
@using Microsoft.AspNetCore.Identity;
@inject IServiceProvider _serviceProvider;
@inject UserManager<Data.ApplicationUser> UserManager
@inject SignInManager<Data.ApplicationUser> SignInManager
@inject HttpClient Http
@inject Hashing.HashingHandler _hashingHandler

@attribute [Authorize(Policy = "AuthenticatedUser")]
<PageTitle>Home</PageTitle>

<AuthorizeView>
    <Authorized>
        @cpr.User
        @if (!isCprValid)
        {
            <input placeholder="Cpr" @bind="cpr.CprNr" />
            <button @onclick="ValidateCpr">Submit</button>
            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <p class="text-danger">@errorMessage</p>
            }
        }
        else
        {
            <div>
                <h3>Add To-Do Item</h3>
                <input placeholder="Item" @bind="todoItem.Item" />
                <button @onclick="AddTodoToDb">Submit To-Do</button>
            </div>

            <div>
                <h3>Existing To-Do Items</h3>
                @if (todoList != null && todoList.Count > 0)
                {
                    <ul>
                        @foreach (var item in decryptedTodoList)
                        {
                            <li>
                                @item.Item
                                <button @onclick="() => DeleteTodo(item.TodoId)">Delete</button>
                            </li>
                        }
                    </ul>
                }
                else
                {
                    <p>No To-Do items found.</p>
                }
            </div>
        }
    </Authorized>
</AuthorizeView>

<AuthorizeView Roles="admin">
    <Authorized>
        <p>You are admin!</p>
    </Authorized>
</AuthorizeView>

@code {
    private Cpr cpr = new Cpr();
    private TodoList todoItem = new TodoList();
    private List<TodoList> todoList = new List<TodoList>();
    private List<TodoList> decryptedTodoList = new List<TodoList>();
    private string? errorMessage;
    private bool isCprValid = false;

    protected override async Task OnInitializedAsync()
    {
        isCprValid = false; 
        var user = await UserManager.GetUserAsync(SignInManager.Context.User);
        if (user != null)
        {
            cpr.User = user.Email;
            await LoadCprAndTodos();
        }
    }

    private async Task LoadCprAndTodos()
    {
        var dbContext = _serviceProvider.GetRequiredService<ToDoDataContext>();
        var existingCpr = await dbContext.Cprs.FirstOrDefaultAsync(x => x.User == cpr.User);

        if (existingCpr != null)
        {
            cpr.Cprid = existingCpr.Cprid; 
            if (existingCpr.CprNr != null)
            {
                isCprValid = true; // Set to true if CPR number is valid
                todoList = await dbContext.TodoLists.Where(t => t.UserId == existingCpr.Cprid).ToListAsync();

                // Decrypt the To-Do items by sending them to the API
                decryptedTodoList = await DecryptTodoItems(todoList);
            }
            else
            {
                isCprValid = false;
            }
        }
        else
        {
            isCprValid = false;
        }
    }

    public async Task ValidateCpr()
    {
        var dbContext = _serviceProvider.GetRequiredService<ToDoDataContext>();
        var existingCpr = await dbContext.Cprs.FirstOrDefaultAsync(x => x.User == cpr.User);

        string hashedCprNr = _hashingHandler.HmcHashing(cpr.CprNr);

        if (existingCpr != null)
        {
            if (existingCpr.CprNr == null)
            {
                existingCpr.CprNr = hashedCprNr; 
                dbContext.Cprs.Update(existingCpr);
                await dbContext.SaveChangesAsync();
            }
            else if (existingCpr.CprNr != hashedCprNr)
            {
                errorMessage = "Not the correct CPR number.";
                isCprValid = false;
                return;
            }

            isCprValid = true;
            todoItem.UserId = existingCpr.Cprid;

            todoList = await dbContext.TodoLists.Where(t => t.UserId == existingCpr.Cprid).ToListAsync();
            decryptedTodoList = await DecryptTodoItems(todoList); // Decrypt
            errorMessage = null;
        }
        else
        {
            var newCpr = new Cpr { User = cpr.User, CprNr = hashedCprNr };
            dbContext.Cprs.Add(newCpr);
            await dbContext.SaveChangesAsync();

            isCprValid = true;
            todoItem.UserId = newCpr.Cprid;
            todoList = new List<TodoList>();
            errorMessage = null;
        }
    }

    public async Task AddTodoToDb()
    {
        if (isCprValid)
        {
            var dbContext = _serviceProvider.GetRequiredService<ToDoDataContext>();

            if (todoItem.UserId == null)
            {
                todoItem.UserId = (await dbContext.Cprs.FirstOrDefaultAsync(x => x.User == cpr.User))?.Cprid;
            }

            if (todoItem.UserId != null)
            {
                // Encrypt the To-Do item before adding it to the DB
                todoItem.Item = await EncryptTodoItem(todoItem.Item);

                dbContext.TodoLists.Add(todoItem);
                await dbContext.SaveChangesAsync();

                todoList = await dbContext.TodoLists.Where(t => t.UserId == todoItem.UserId).ToListAsync();
                decryptedTodoList = await DecryptTodoItems(todoList); // Decrypt list
                todoItem = new TodoList { UserId = todoItem.UserId }; // Reset todoItem for next entry
                errorMessage = "To-Do item added successfully!";
            }
            else
            {
                errorMessage = "You must validate your CPR number first.";
            }
        }
        else
        {
            errorMessage = "You must validate your CPR number first.";
        }
    }

    private async Task<string> EncryptTodoItem(string todoItem)
    {
        var response = await Http.PostAsJsonAsync("api/todo/encrypt", todoItem);
        return await response.Content.ReadAsStringAsync();
    }

    private async Task<List<TodoList>> DecryptTodoItems(List<TodoList> encryptedTodoList)
    {

        var decryptedList = new List<TodoList>();

        foreach (var encryptedItem in encryptedTodoList)
        {
            var response = await Http.PostAsJsonAsync("api/todo/decrypt", encryptedItem.Item);
            var decryptedItem = await response.Content.ReadAsStringAsync();

            decryptedList.Add(new TodoList
            {
                TodoId = encryptedItem.TodoId,
                Item = decryptedItem,
                UserId = encryptedItem.UserId
            });
        }

        return decryptedList;
    }

    public async Task DeleteTodo(int todoId)
    {
        var dbContext = _serviceProvider.GetRequiredService<ToDoDataContext>();
        var todoItemToDelete = await dbContext.TodoLists.FindAsync(todoId);

        if (todoItemToDelete != null)
        {
            dbContext.TodoLists.Remove(todoItemToDelete);
            await dbContext.SaveChangesAsync();

            todoList = await dbContext.TodoLists.Where(t => t.UserId == todoItemToDelete.UserId).ToListAsync();
            decryptedTodoList = await DecryptTodoItems(todoList); // Decrypt
        }
    }
}
